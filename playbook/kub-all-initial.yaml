---
#ansible-galaxy collection install ansible.posix
#ansible-galaxy collection install community.general

- name: Prepare all nodes for kubernetes
  hosts: kuball
  become: yes
  tasks:

  - name: Ensure all packages are at latest version
    yum:
      name: '*'
      state: latest

  - name: Ensure SELinux is disabled
    ansible.posix.selinux:
      state: disabled
      
  - name: Ensure br_netfilter module is loaded
    community.general.modprobe:
        name: br_netfilter
        state: present

  - name: Ensure masquerade is enabled for internal zone 
    firewalld:
      zone: internal
      masquerade: yes
      permanent: true
      state: enabled
          
  - name: Ensure net.bridge.bridge-nf-call-iptables is enabled
    sysctl:
        name: net.bridge.bridge-nf-call-iptables
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
        
  - name: Ensure net.bridge.bridge-nf-call-ip6tables is enabled
    sysctl:
        name: net.bridge.bridge-nf-call-ip6tables
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
        
  - name: Disable swap for current session
    command: swapoff -a

  - name: Ensure swap is permanently disabled
    replace:
      path: /etc/fstab
      regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
      replace: '#\1\2\3swap\4'
      backup: yes


  - name: Ensure docker repository is enabled
    get_url:
      url: https://download.docker.com/linux/centos/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo
   
  - name: Ensure containerd.io latest version is installed
    yum:
      name: 'containerd.io'
      state: latest

#- name: Reboot the machine
#  reboot:
